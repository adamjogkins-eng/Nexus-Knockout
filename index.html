<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nexus Knockout Pro - Ultra Luminous</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --gold: #f1c40f;
            --secret: #ff00ea;
            --melee: #ff4d4d;
            --ranged: #00d2ff;
            --hybrid: #a55eea;
            --special: #20bf6b;
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Orbitron', sans-serif; 
            background: #000; 
            user-select: none; 
            -webkit-user-select: none; 
            color: white; 
            touch-action: none;
            width: 100vw;
            height: 100vh;
        }
        
        canvas { display: block; width: 100%; height: 100%; }

        /* Overdrive Flash Effect */
        #overdrive-flash {
            position: fixed;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 200;
        }

        .screen-overlay {
            position: fixed; 
            inset: 0; 
            background: radial-gradient(circle at center, #0a0b14 0%, #000 100%);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            z-index: 100; 
            padding: calc(20px + var(--safe-top)) 20px calc(20px + var(--safe-bottom));
            box-sizing: border-box;
            overflow-y: auto;
        }

        #overlay { 
            position: absolute; 
            inset: 0; 
            pointer-events: none; 
            display: none; 
            flex-direction: column; 
            justify-content: space-between; 
            z-index: 5; 
            padding: var(--safe-top) 0 var(--safe-bottom);
        }

        .codex-trigger {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 110;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: 0.3s;
        }

        .update-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 200;
            display: none;
            padding: 40px 20px;
            overflow-y: auto;
            text-align: left;
        }
        .update-modal h2 { color: var(--gold); border-bottom: 2px solid var(--gold); padding-bottom: 10px; font-size: 20px; }
        .update-modal p { color: #888; font-style: italic; margin-bottom: 20px; font-size: 12px; }
        .update-modal ul { list-style: none; padding: 0; }
        .update-modal li { margin-bottom: 20px; padding-left: 20px; position: relative; font-size: 13px; line-height: 1.6; color: #eee; }
        .update-modal li strong { color: var(--gold); display: block; margin-bottom: 4px; }
        .update-modal li::before { content: "●"; position: absolute; left: 0; color: var(--gold); font-size: 10px; top: 5px; }
        .close-btn { background: #e74c3c; border: none; color: white; padding: 10px 20px; font-family: 'Orbitron'; cursor: pointer; border-radius: 5px; margin-top: 20px; width: 100%; }

        .selection-container { width: 100%; max-width: 1200px; padding-bottom: 80px; }
        .category-section { margin-bottom: 60px; }
        .category-header { font-size: 16px; letter-spacing: 4px; color: #888; margin-bottom: 25px; padding-left: 15px; border-left: 4px solid #444; text-transform: uppercase; font-weight: 900; }
        .category-header.melee { border-color: var(--melee); color: var(--melee); }
        .category-header.ranged { border-color: var(--ranged); color: var(--ranged); }
        .category-header.hybrid { border-color: var(--hybrid); color: var(--hybrid); }
        .category-header.special { border-color: var(--special); color: var(--special); }
        .category-header.secret { border-color: var(--secret); color: var(--secret); }

        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 10px; }
        .char-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
            padding: 25px 5px; text-align: center; cursor: pointer; transition: all 0.2s ease; font-size: 10px;
            font-weight: 700; text-transform: uppercase; position: relative; letter-spacing: 1px;
        }
        .char-card:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .char-card:active { border-color: var(--gold); transform: scale(0.95); }
        .type-tag { font-size: 7px; margin-top: 6px; opacity: 0.5; font-weight: 400; letter-spacing: 2px; display: block; }
        .locked { opacity: 0.2; background: repeating-linear-gradient(45deg, #0a0a0a, #0a0a0a 10px, #151515 10px, #151515 20px); cursor: not-allowed; filter: grayscale(1); }
        .secret-unlocked { border-color: var(--secret) !important; box-shadow: 0 0 20px rgba(255, 0, 234, 0.2); }

        .hud-container { display: flex; justify-content: space-between; padding: 10px; width: 100%; box-sizing: border-box; }
        .player-card { background: rgba(0, 0, 0, 0.8); padding: 12px; border-radius: 12px; border-bottom: 4px solid #00d2ff; width: 32%; max-width: 200px; backdrop-filter: blur(10px); }
        .damage-val { font-size: clamp(20px, 6vw, 32px); font-weight: 900; color: #ff4d4d; margin: 4px 0; }
        .ko-counter { font-size: 10px; color: var(--gold); font-weight: 900; }
        .sp-bar { width: 100%; height: 8px; background: #111; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .sp-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--gold), #ff9f43); transition: width 0.1s; }
        
        .controls { display: flex; justify-content: space-between; align-items: flex-end; padding: 25px; pointer-events: auto; width: 100%; box-sizing: border-box; }
        #joystick-outer { width: 110px; height: 110px; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); position: relative; }
        #joystick-knob { width: 45px; height: 45px; background: #fff; border-radius: 50%; position: absolute; top: 32.5px; left: 32.5px; }
        .btn-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .btn { width: 65px; height: 65px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn-sp { grid-column: span 2; width: 100%; border-radius: 12px; height: 45px; border-color: var(--gold); color: var(--gold); }
        .menu-btn { padding: 14px 28px; background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 10px; cursor: pointer; font-family: 'Orbitron'; margin: 6px; }
        #code-input { margin: 20px 0; background: #080808; border: 1px solid #222; color: #0f0; padding: 15px; font-family: 'Orbitron'; width: 85%; max-width: 450px; text-align: center; border-radius: 10px; }
    </style>
</head>
<body>

<div id="overdrive-flash"></div>

<div class="codex-trigger" onclick="toggleUpdateLog()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gold);"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
</div>

<div id="update-modal" class="update-modal">
    <h2>Combat Codex: Alpha 1.7 - Supernova</h2>
    <p>Modified by the Nexus Architect</p>
    <ul>
        <li><strong>Luminous Stasis:</strong> The Void's Overdrive now ignites the arena with high-intensity photon clusters.</li>
        <li><strong>Dynamic Illumination:</strong> Every "Seraph" orb acts as a point light, illuminating the frozen battlefield.</li>
        <li><strong>Screen Distortion:</strong> High-energy attacks now cause visual impact tremors.</li>
    </ul>
    <button class="close-btn" onclick="toggleUpdateLog()">CLOSE</button>
</div>

<div id="start-screen" class="screen-overlay">
    <h1 style="font-size: 32px; letter-spacing: 8px; margin-bottom: 5px; font-weight: 900;">NEXUS KNOCKOUT</h1>
    <p style="color: var(--gold); margin-bottom: 30px; font-size: 14px; letter-spacing: 3px;">LEGACY EDITION • 110 FIGHTERS</p>
    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
        <button class="menu-btn" onclick="setMode('ranked')" id="mode-ranked" style="border-color: var(--gold);">RANKED</button>
        <button class="menu-btn" onclick="setMode('spectate')" id="mode-spec">SPECTATE</button>
    </div>
    <input type="text" id="code-input" placeholder="PASTE NUMERIC KEY HERE" oninput="checkCode(this.value)">
    <div class="selection-container" id="selection-container"></div>
</div>

<div id="overlay">
    <div class="hud-container">
        <div class="player-card">
            <div id="p1-name" style="font-size: 11px; color: #00d2ff;">PLAYER</div>
            <div id="p1-damage" class="damage-val">0%</div>
            <div id="p1-kos" class="ko-counter">KOs: 0</div>
            <div class="sp-bar"><div id="p1-sp" class="sp-fill"></div></div>
        </div>
        <div id="p-toggle" style="pointer-events: auto; cursor: pointer; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 50%;" onclick="togglePause()">II</div>
        <div class="player-card" style="border-bottom-color: #ff4d4d; text-align: right;">
            <div id="p2-name" style="font-size: 11px; color: #ff4d4d;">OPPONENT</div>
            <div id="p2-damage" class="damage-val">0%</div>
            <div id="p2-kos" class="ko-counter">KOs: 0</div>
            <div class="sp-bar"><div id="p2-sp" class="sp-fill"></div></div>
        </div>
    </div>
    <div id="game-controls" class="controls">
        <div id="joystick-outer"><div id="joystick-knob"></div></div>
        <div class="btn-group">
            <div id="btn-attack" class="btn" style="border-color: #e74c3c;">ATK</div>
            <div id="btn-jump" class="btn" style="border-color: #3498db;">JMP</div>
            <div id="btn-special" class="btn btn-sp">OVERDRIVE</div>
        </div>
    </div>
</div>

<div id="pause-screen" class="screen-overlay" style="display: none; background: rgba(0,0,0,0.9); justify-content: center;">
    <h1 style="color: var(--gold); margin-bottom: 30px; letter-spacing: 10px;">HALTED</h1>
    <button class="menu-btn" style="background: #27ae60; width: 220px;" onclick="togglePause()">RESUME</button>
    <button class="menu-btn" style="background: #e74c3c; width: 220px; margin-top: 15px;" onclick="resetToMenu()">QUIT</button>
</div>

<script>
    const SECRET_CODE = "28347288858472282824877381938858558488294948373848585838224475848282845848382828485574383828";
    
    const CHARS = {
        prime:   { color: 0xff3e3e, speed: 0.16, jump: 0.55, power: 1.2, type: 'melee' },
        speedy:  { color: 0x00ccff, speed: 0.28, jump: 0.50, power: 0.6, type: 'melee' },
        shatter: { color: 0xe0e0e0, speed: 0.12, jump: 0.45, power: 1.8, type: 'melee' },
        ninja:   { color: 0x222222, speed: 0.22, jump: 0.65, power: 0.8, type: 'melee' },
        titan:   { color: 0x7f8c8d, speed: 0.10, jump: 0.48, power: 2.2, type: 'melee' },
        volt:    { color: 0xf1c40f, speed: 0.24, jump: 0.55, power: 0.8, type: 'melee' },
        demon:   { color: 0xc0392b, speed: 0.15, jump: 0.56, power: 1.7, type: 'melee' },
        glitch:  { color: 0x00e5ff, speed: 0.30, jump: 0.45, power: 0.9, type: 'melee' },
        rogue:   { color: 0x004d40, speed: 0.24, jump: 0.56, power: 0.9, type: 'melee' },
        ghost:   { color: 0xffffff, speed: 0.18, jump: 0.70, power: 0.7, type: 'melee' },
        ember:   { color: 0xff5722, speed: 0.16, jump: 0.55, power: 1.3, type: 'melee' },
        venom:   { color: 0x4caf50, speed: 0.20, jump: 0.58, power: 0.8, type: 'melee' },
        chrono:  { color: 0x3f51b5, speed: 0.19, jump: 0.55, power: 0.9, type: 'melee' },
        vortex:  { color: 0x673ab7, speed: 0.15, jump: 0.62, power: 1.1, type: 'melee' },
        cyber:   { color: 0x00bcd4, speed: 0.22, jump: 0.50, power: 0.8, type: 'melee' },
        iron:    { color: 0x607d8b, speed: 0.11, jump: 0.45, power: 2.0, type: 'melee' },
        spark:   { color: 0xffeb3b, speed: 0.26, jump: 0.54, power: 0.7, type: 'melee' },
        shadow:  { color: 0x212121, speed: 0.21, jump: 0.60, power: 1.0, type: 'melee' },
        blade:   { color: 0xf44336, speed: 0.20, jump: 0.57, power: 1.1, type: 'melee' },
        draco:   { color: 0x795548, speed: 0.14, jump: 0.51, power: 1.5, type: 'melee' },
        neon:    { color: 0x00ff00, speed: 0.25, jump: 0.55, power: 0.8, type: 'melee' },
        zenith:  { color: 0xffd700, speed: 0.17, jump: 0.58, power: 1.3, type: 'melee' },
        rift:    { color: 0x4b0082, speed: 0.15, jump: 0.65, power: 1.1, type: 'melee' },
        samurai: { color: 0xfffafa, speed: 0.23, jump: 0.55, power: 1.1, type: 'melee' },
        monk:    { color: 0xf39c12, speed: 0.21, jump: 0.68, power: 0.8, type: 'melee' },
        brawler: { color: 0xbdc3c7, speed: 0.18, jump: 0.50, power: 1.4, type: 'melee' },
        reaper:  { color: 0x2c3e50, speed: 0.16, jump: 0.60, power: 1.5, type: 'melee' },
        slugger: { color: 0xd35400, speed: 0.14, jump: 0.48, power: 1.9, type: 'melee' },
        pulse:   { color: 0x00ff88, speed: 0.15, jump: 0.55, power: 1.0, type: 'ranged' },
        gunner:  { color: 0x95a5a6, speed: 0.15, jump: 0.52, power: 0.8, type: 'ranged' },
        mage:    { color: 0x9b59b6, speed: 0.12, jump: 0.52, power: 0.9, type: 'ranged' },
        archer:  { color: 0x27ae60, speed: 0.16, jump: 0.54, power: 0.9, type: 'ranged' },
        frost:   { color: 0xbbdefb, speed: 0.14, jump: 0.52, power: 1.1, type: 'ranged' },
        blast:   { color: 0xffc107, speed: 0.13, jump: 0.50, power: 1.6, type: 'ranged' },
        plasma:  { color: 0xe91e63, speed: 0.17, jump: 0.56, power: 1.2, type: 'ranged' },
        echo:    { color: 0x8bc34a, speed: 0.18, jump: 0.53, power: 0.9, type: 'ranged' },
        omega:   { color: 0xff00ff, speed: 0.16, jump: 0.55, power: 1.4, type: 'ranged' },
        solar:   { color: 0xffa500, speed: 0.18, jump: 0.54, power: 1.2, type: 'ranged' },
        comet:   { color: 0x34495e, speed: 0.20, jump: 0.60, power: 0.8, type: 'ranged' },
        laser:   { color: 0x1abc9c, speed: 0.15, jump: 0.50, power: 1.1, type: 'ranged' },
        sniper:  { color: 0x7f8c8d, speed: 0.12, jump: 0.48, power: 2.1, type: 'ranged' },
        orb:     { color: 0x8e44ad, speed: 0.14, jump: 0.70, power: 0.8, type: 'ranged' },
        wasp:    { color: 0xf1c40f, speed: 0.30, jump: 0.60, power: 0.4, type: 'ranged' },
        storm:   { color: 0x2980b9, speed: 0.16, jump: 0.55, power: 1.3, type: 'ranged' },
        nebula:  { color: 0x2c3e50, speed: 0.14, jump: 0.55, power: 1.2, type: 'ranged' },
        flare:   { color: 0xe67e22, speed: 0.18, jump: 0.54, power: 1.1, type: 'ranged' },
        valkyrie:{ color: 0xfcf3cf, speed: 0.20, jump: 0.65, power: 1.2, type: 'hybrid' },
        paladin: { color: 0xd4ac0d, speed: 0.12, jump: 0.45, power: 1.8, type: 'hybrid' },
        warlock: { color: 0x4a235a, speed: 0.14, jump: 0.58, power: 1.4, type: 'hybrid' },
        spectre: { color: 0xecf0f1, speed: 0.25, jump: 0.75, power: 0.7, type: 'hybrid' },
        shade:   { color: 0x17202a, speed: 0.22, jump: 0.62, power: 1.1, type: 'hybrid' },
        guardian:{ color: 0x1b4f72, speed: 0.10, jump: 0.42, power: 2.5, type: 'hybrid' },
        stalker: { color: 0x186a3b, speed: 0.24, jump: 0.55, power: 0.9, type: 'hybrid' },
        wraith:  { color: 0x4d5656, speed: 0.19, jump: 0.70, power: 1.0, type: 'hybrid' },
        enigma:  { color: 0x512e5f, speed: 0.16, jump: 0.60, power: 1.3, type: 'hybrid' },
        colossus:{ color: 0x212f3c, speed: 0.08, jump: 0.35, power: 3.5, type: 'hybrid' },
        phantom: { color: 0xfdfefe, speed: 0.28, jump: 0.80, power: 0.6, type: 'hybrid' },
        siren:   { color: 0x1abc9c, speed: 0.18, jump: 0.65, power: 1.1, type: 'hybrid' },
        joker:   { color: 0x9b59b6, speed: 0.24, jump: 0.75, power: 0.7, type: 'special' },
        mime:    { color: 0xffffff, speed: 0.15, jump: 0.50, power: 1.2, type: 'special' },
        engineer:{ color: 0xe67e22, speed: 0.13, jump: 0.48, power: 1.4, type: 'special' },
        hacker:  { color: 0x2ecc71, speed: 0.22, jump: 0.55, power: 0.8, type: 'special' },
        medic:   { color: 0xe74c3c, speed: 0.18, jump: 0.52, power: 0.7, type: 'special' },
        pilot:   { color: 0x3498db, speed: 0.26, jump: 0.45, power: 0.9, type: 'special' },
        chemist: { color: 0xf1c40f, speed: 0.14, jump: 0.50, power: 1.3, type: 'special' },
        clown:   { color: 0xe91e63, speed: 0.20, jump: 0.70, power: 1.0, type: 'special' },
        hazard:  { color: 0x32ff00, speed: 0.15, jump: 0.55, power: 1.0, type: 'melee', locked: true },
        virus:   { color: 0x00ff00, speed: 0.25, jump: 0.45, power: 0.8, type: 'ranged', locked: true },
        corrupt: { color: 0x330033, speed: 0.10, jump: 0.40, power: 2.5, type: 'hybrid', locked: true },
        anomaly: { color: 0x555555, speed: 0.30, jump: 0.90, power: 0.5, type: 'special', locked: true },
        flux:    { color: 0x00ffa2, speed: 0.35, jump: 0.75, power: 1.0, type: 'special', locked: true },
        null:    { color: 0x222222, speed: 0.18, jump: 0.60, power: 2.0, type: 'hybrid', locked: true },
        singularity: { color: 0x4500ff, speed: 0.12, jump: 0.50, power: 2.5, type: 'hybrid', locked: true },
        relic:   { color: 0xd4af37, speed: 0.12, jump: 0.50, power: 1.8, type: 'melee', locked: true },
        ancient: { color: 0x704214, speed: 0.11, jump: 0.45, power: 2.2, type: 'hybrid', locked: true },
        proto:   { color: 0x00ffff, speed: 0.20, jump: 0.60, power: 1.1, type: 'special', locked: true },
        cipher:  { color: 0x0a0a0a, speed: 0.22, jump: 0.55, power: 0.9, type: 'ranged', locked: true },
        marrow:  { color: 0xffffff, speed: 0.18, jump: 0.58, power: 1.3, type: 'melee', locked: true },
        tome:    { color: 0x4a148c, speed: 0.10, jump: 0.65, power: 1.6, type: 'ranged', locked: true },
        clay:    { color: 0x8d6e63, speed: 0.09, jump: 0.40, power: 2.8, type: 'melee', locked: true },
        vein:    { color: 0xb71c1c, speed: 0.24, jump: 0.55, power: 0.9, type: 'hybrid', locked: true },
        cog:     { color: 0x455a64, speed: 0.15, jump: 0.48, power: 1.5, type: 'special', locked: true },
        dust:    { color: 0xeceff1, speed: 0.35, jump: 0.70, power: 0.4, type: 'special', locked: true },
        shard:   { color: 0x03a9f4, speed: 0.21, jump: 0.52, power: 1.2, type: 'ranged', locked: true },
        golem:   { color: 0x3e2723, speed: 0.07, jump: 0.30, power: 4.5, type: 'melee', locked: true },
        wisp:    { color: 0xe1f5fe, speed: 0.20, jump: 0.85, power: 0.6, type: 'special', locked: true },
        echo_v2: { color: 0x00e676, speed: 0.18, jump: 0.55, power: 1.0, type: 'hybrid', locked: true },
        void_p:  { color: 0x121212, speed: 0.16, jump: 0.60, power: 1.4, type: 'special', locked: true },
        lux:     { color: 0xffeb3b, speed: 0.28, jump: 0.65, power: 0.8, type: 'ranged', locked: true },
        void:      { color: 0x000000, speed: 0.15, jump: 0.65, power: 12.0, type: 'boss', locked: true, skill: 'VOID_SERAPH' },
        "entity-303": { color: 0xffffff, speed: 0.35, jump: 0.80, power: 3.5, type: 'boss', locked: true },
        "overseer":   { color: 0xff00ea, speed: 0.20, jump: 0.70, power: 5.0, type: 'boss', locked: true },
        "supernova":  { color: 0xffaa00, speed: 0.18, jump: 0.60, power: 6.5, type: 'boss', locked: true },
        "oblivion":   { color: 0x1a1a1a, speed: 0.25, jump: 0.55, power: 4.8, type: 'boss', locked: true },
        "rapture":    { color: 0x00ffcc, speed: 0.30, jump: 0.75, power: 3.8, type: 'boss', locked: true },
        "doomlord":   { color: 0x550000, speed: 0.12, jump: 0.50, power: 10.0, type: 'boss', locked: true },
        "spectre_x":  { color: 0x777777, speed: 0.40, jump: 0.90, power: 2.5, type: 'boss', locked: true },
        "paradox":    { color: 0x3300ff, speed: 0.28, jump: 0.85, power: 4.2, type: 'boss', locked: true },
        "excalibur":  { color: 0xe5e4e2, speed: 0.24, jump: 0.65, power: 7.0, type: 'boss', locked: true },
        "genesis":    { color: 0xffffff, speed: 0.20, jump: 1.00, power: 5.5, type: 'boss', locked: true },
        "thanos":     { color: 0x4a148c, speed: 0.10, jump: 0.40, power: 12.0, type: 'boss', locked: true },
        "apollo":     { color: 0xffd600, speed: 0.22, jump: 0.70, power: 6.0, type: 'boss', locked: true },
        "hades":      { color: 0x212121, speed: 0.18, jump: 0.55, power: 8.5, type: 'boss', locked: true },
        "zeus":       { color: 0x00b0ff, speed: 0.25, jump: 0.65, power: 7.5, type: 'boss', locked: true },
        "odin":       { color: 0x5d4037, speed: 0.15, jump: 0.50, power: 9.0, type: 'boss', locked: true }
    };

    let scene, camera, renderer, fighters = [], gameRunning = false, isPaused = false;
    let projectiles = [], currentMode = 'ranked', selectedPlayerType = 'prime';
    let stage, targetZoom = 60, cameraTarget = new THREE.Vector3();
    let shakeIntensity = 0;

    const input = { x: 0, jump: false, attack: false, special: false };

    function toggleUpdateLog() {
        const modal = document.getElementById('update-modal');
        modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
    }

    function checkCode(val) {
        if (val.trim() === SECRET_CODE) {
            Object.keys(CHARS).forEach(k => { CHARS[k].locked = false; });
            populateUI();
            document.getElementById('code-input').style.borderColor = "#ff00ea";
        }
    }

    function createSection(title, type, items) {
        if (!items.length) return "";
        let grid = items.map(k => {
            const c = CHARS[k];
            return `<div class="char-card ${c.locked ? 'locked' : ''} ${c.type==='boss'?'secret-unlocked':''}" onclick="startMatch('${k}')">${k}<span class="type-tag">${c.type.toUpperCase()}</span></div>`;
        }).join('');
        return `<div class="category-section"><div class="category-header ${type}">${title}</div><div class="char-grid">${grid}</div></div>`;
    }

    function populateUI() {
        const cont = document.getElementById('selection-container');
        const g = { m:[], r:[], h:[], s:[], b:[], l:[] };
        Object.keys(CHARS).forEach(k => {
            if(CHARS[k].locked) g.l.push(k);
            else if(CHARS[k].type==='melee') g.m.push(k);
            else if(CHARS[k].type==='ranged') g.r.push(k);
            else if(CHARS[k].type==='hybrid') g.h.push(k);
            else if(CHARS[k].type==='special') g.s.push(k);
            else if(CHARS[k].type==='boss') g.b.push(k);
        });
        cont.innerHTML = createSection("Strike Force", "melee", g.m) + createSection("Artillery", "ranged", g.r) + createSection("Synthesis", "hybrid", g.h) + createSection("Tactical", "special", g.s) + createSection("Divine", "secret", g.b) + createSection("Restricted", "locked", g.l);
    }

    function startMatch(type) {
        if(CHARS[type].locked) return;
        selectedPlayerType = type;
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('overlay').style.display = 'flex';
        initScene();
    }

    function createProp(w, h, d, x, y, z, color = 0x222233) {
        const mesh = new THREE.Mesh(
            new THREE.BoxGeometry(w, h, d),
            new THREE.MeshStandardMaterial({color, metalness: 0.5, roughness: 0.3})
        );
        mesh.position.set(x, y, z);
        mesh.receiveShadow = true;
        mesh.castShadow = true;
        scene.add(mesh);
        return mesh;
    }

    function initScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205);
        scene.fog = new THREE.Fog(0x020205, 50, 150);

        camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 80);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);
        
        const ambient = new THREE.AmbientLight(0x202020, 0.4); 
        scene.add(ambient);
        
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.2);
        mainLight.position.set(30, 60, 40);
        mainLight.castShadow = true;
        scene.add(mainLight);

        stage = new THREE.Mesh(
            new THREE.BoxGeometry(100, 4, 30), 
            new THREE.MeshStandardMaterial({color: 0x05050a, roughness: 0.1, metalness: 0.9})
        );
        stage.position.y = -2;
        stage.receiveShadow = true;
        scene.add(stage);

        createProp(12, 70, 12, -58, 25, -18);
        createProp(12, 70, 12, 58, 25, -18);
        createProp(5, 20, 5, -35, 8, -12);
        createProp(5, 20, 5, 35, 8, -12);
        createProp(130, 25, 6, 0, 8, -28, 0x080815);

        const enemyType = Object.keys(CHARS)[Math.floor(Math.random()*Object.keys(CHARS).length)];
        fighters = [new Fighter(selectedPlayerType, -25, false), new Fighter(enemyType, 25, true)];
        
        gameRunning = true; 
        setupControls(); 
        animate();
    }

    class Projectile {
        constructor(pos, vel, owner, color, size=0.8, homing=false, type='normal') {
            this.type = type;
            const mat = new THREE.MeshBasicMaterial({color, transparent:true, opacity:0.9});
            this.mesh = new THREE.Mesh(new THREE.SphereGeometry(size, 8, 8), mat);
            this.mesh.position.copy(pos);
            this.vel = vel; 
            this.owner = owner; 
            this.homing = homing;

            // Add intense light if it's a Seraph orb
            if(this.type === 'seraph') {
                this.light = new THREE.PointLight(color, 12, 15);
                this.mesh.add(this.light);
                this.mesh.scale.set(1.5, 1.5, 1.5);
            }

            scene.add(this.mesh); 
            projectiles.push(this);
        }
        update() {
            if(this.homing) {
                const target = fighters.find(f => f !== this.owner);
                if(target) {
                    const dir = new THREE.Vector3().subVectors(target.mesh.position, this.mesh.position).normalize();
                    const speed = this.type === 'seraph' ? 6.8 : 1.5;
                    this.vel.lerp(dir.multiplyScalar(speed), 0.45);
                }
            }
            this.mesh.position.add(this.vel);
            
            fighters.forEach(f => {
                if(f !== this.owner && this.mesh.position.distanceTo(f.mesh.position) < 4.5) {
                    if (this.type === 'seraph') {
                        this.owner.kos += 1;
                        f.takeHit(Math.sign(this.vel.x), this.owner.stats.power * 0.5);
                        shakeIntensity = 0.8;
                    } else {
                        f.takeHit(Math.sign(this.vel.x), this.owner.stats.power);
                        if(!this.homing) this.destroy();
                    }
                }
            });
            
            if(Math.abs(this.mesh.position.x) > 200 || Math.abs(this.mesh.position.y) > 200) this.destroy();
        }
        destroy() { 
            if(this.light) this.mesh.remove(this.light);
            scene.remove(this.mesh); 
            projectiles = projectiles.filter(p => p !== this); 
        }
    }

    class Fighter {
        constructor(type, x, isBot) {
            this.type = type; this.isBot = isBot; this.stats = CHARS[type];
            this.damage = 0; this.sp = (this.type === 'void') ? 100 : 0; this.kos = 0;
            this.vel = new THREE.Vector3(); this.onGround = false; this.facing = x < 0 ? 1 : -1;
            this.jumpCooldown = 0;
            this.stasisTimer = 0;
            this.mesh = new THREE.Group();
            
            // Character body with higher glow
            const b = new THREE.Mesh(
                new THREE.BoxGeometry(2.5, 3.5, 2.5), 
                new THREE.MeshStandardMaterial({
                    color: this.stats.color, 
                    emissive: this.stats.color, 
                    emissiveIntensity: 0.8,
                    metalness: 0.5,
                    roughness: 0.2
                })
            );
            b.position.y = 1.75; 
            b.castShadow = true;
            this.mesh.add(b);
            
            // Character aura light
            this.aura = new THREE.PointLight(this.stats.color, 2, 8);
            this.aura.position.y = 1.75;
            this.mesh.add(this.aura);

            this.mesh.position.set(x, 10, 0); 
            scene.add(this.mesh);
        }
        update() {
            if(this.stasisTimer > 0) {
                this.stasisTimer--;
                this.vel.set(0, 0, 0);
                this.updateHUD();
                // Visual glitch during stasis
                this.mesh.scale.set(0.9 + Math.random()*0.2, 0.9 + Math.random()*0.2, 0.9 + Math.random()*0.2);
                return; 
            }
            this.mesh.scale.set(1, 1, 1);

            if(this.isBot) this.runAI(); else this.handleInput();
            
            if(this.type === 'void') {
                this.sp = 100;
                const target = fighters.find(f => f !== this);
                if(target && target.mesh.position.distanceTo(this.mesh.position) < 15) {
                    target.damage += 0.35;
                }
            }
            
            this.vel.y -= 0.045; 
            this.mesh.position.add(this.vel);
            
            if(this.mesh.position.y < 0 && Math.abs(this.mesh.position.x) < 50) { 
                this.mesh.position.y = 0; 
                this.vel.y = 0; 
                this.onGround = true; 
            } else {
                this.onGround = false;
            }
            
            if(Math.abs(this.mesh.position.x) > 120 || this.mesh.position.y < -50) this.die();
            
            this.vel.x *= 0.92; 
            this.updateHUD();
            if(this.jumpCooldown > 0) this.jumpCooldown--;
        }
        handleInput() {
            if(Math.abs(input.x) > 0.1) { 
                this.vel.x += input.x * this.stats.speed; 
                this.facing = Math.sign(input.x); 
            }
            if(input.jump && this.onGround) { 
                this.vel.y = this.stats.jump; 
                input.jump = false; 
            }
            if(input.attack) { 
                this.attack(); 
                input.attack = false; 
            }
            if(input.special && this.sp >= 100) { 
                this.useSkill(); 
                input.special = false; 
            }
        }
        runAI() {
            const t = fighters.find(f => f !== this);
            if(!t) return;
            const dist = Math.abs(t.mesh.position.x - this.mesh.position.x);
            if(dist > 8) {
                this.vel.x += Math.sign(t.mesh.position.x - this.mesh.position.x) * this.stats.speed;
                this.facing = Math.sign(t.mesh.position.x - this.mesh.position.x) || this.facing;
            }
            if(Math.random() < 0.03) this.attack();
            if(this.sp >= 100 && Math.random() < 0.02) this.useSkill();
            if(this.onGround && this.jumpCooldown <= 0) {
                if(Math.abs(this.mesh.position.x) > 40 || Math.random() < 0.01) {
                    this.vel.y = this.stats.jump;
                    this.jumpCooldown = 70 + Math.random() * 50;
                }
            }
        }
        attack() { 
            new Projectile(this.mesh.position.clone().add(new THREE.Vector3(0, 1.75, 0)), new THREE.Vector3(this.facing * 1.8, 0, 0), this, this.stats.color); 
        }
        useSkill() {
            if(this.type !== 'void') this.sp = 0;
            
            if(this.stats.skill === 'VOID_SERAPH') {
                // Visual Flash
                const flash = document.getElementById('overdrive-flash');
                flash.style.opacity = '1';
                setTimeout(() => flash.style.opacity = '0', 200);
                shakeIntensity = 1.5;

                // Apply Stasis to ALL other fighters
                fighters.forEach(f => {
                    if(f !== this) f.stasisTimer = 180;
                });

                // Ultra Bright Swarm
                for(let i=0; i<35; i++) {
                    setTimeout(() => {
                        const v = new THREE.Vector3(this.facing * 8.5, (Math.random()-0.5)*12, (Math.random()-0.5)*6);
                        new Projectile(this.mesh.position.clone().add(new THREE.Vector3(0, 1.75, 0)), v, this, 0xff00ea, 2.0, true, 'seraph');
                    }, i * 35);
                }
            } else {
                new Projectile(this.mesh.position.clone().add(new THREE.Vector3(0,1.75,0)), new THREE.Vector3(this.facing * 4, 0, 0), this, this.stats.color, 5);
            }
        }
        takeHit(dir, pwr) { 
            if(this.type === 'void') return; 
            this.damage += 8 * pwr; 
            if(this.stasisTimer <= 0) {
                const knockback = (this.damage / 8);
                this.vel.x += dir * knockback * 0.5; 
                this.vel.y += knockback * 0.3; 
            }
            this.sp = Math.min(100, this.sp + 15); 
        }
        die() { 
            const opponent = fighters.find(f => f !== this);
            if(opponent) opponent.kos++;
            this.damage = 0; 
            this.stasisTimer = 0;
            this.mesh.position.set(this.facing < 0 ? 30 : -30, 40, 0); 
            this.vel.set(0,0,0);
        }
        updateHUD() {
            const id = fighters[0] === this ? 'p1' : 'p2';
            document.getElementById(id+'-damage').innerText = Math.floor(this.damage) + '%';
            document.getElementById(id+'-sp').style.width = this.sp + '%';
            document.getElementById(id+'-kos').innerText = 'KOs: ' + this.kos;
            document.getElementById(id+'-name').innerText = (this.stasisTimer > 0 ? "FROZEN" : this.type.toUpperCase());
        }
    }

    function updateCamera() {
        if(fighters.length < 2) return;
        const p1 = fighters[0].mesh.position;
        const p2 = fighters[1].mesh.position;
        const midX = (p1.x + p2.x) / 2;
        const midY = (p1.y + p2.y) / 2;
        const dist = Math.abs(p1.x - p2.x);
        
        targetZoom = 50 + (dist * 0.7);
        targetZoom = Math.max(45, Math.min(140, targetZoom));
        
        cameraTarget.lerp(new THREE.Vector3(midX, midY + 4, 0), 0.1);
        
        // Apply Screen Shake
        const sx = (Math.random() - 0.5) * shakeIntensity;
        const sy = (Math.random() - 0.5) * shakeIntensity;
        shakeIntensity *= 0.9;

        camera.position.x += (cameraTarget.x - camera.position.x + sx) * 0.08;
        camera.position.y += ((cameraTarget.y + 12) - camera.position.y + sy) * 0.08;
        camera.position.z += (targetZoom - camera.position.z) * 0.08;
        camera.lookAt(cameraTarget);
    }

    function animate() {
        if(!gameRunning || isPaused) { if(gameRunning) requestAnimationFrame(animate); return; }
        requestAnimationFrame(animate);
        fighters.forEach(f => f.update());
        projectiles.forEach(p => p.update());
        updateCamera();
        renderer.render(scene, camera);
    }

    function setupControls() {
        const o = document.getElementById('joystick-outer'), k = document.getElementById('joystick-knob');
        const move = (e) => {
            const r = o.getBoundingClientRect(), cx = r.left + r.width/2, cy = r.top + r.height/2;
            const dx = (e.clientX || e.touches[0].clientX) - cx;
            const dy = (e.clientY || e.touches[0].clientY) - cy;
            const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 50);
            k.style.transform = `translate(${dx/(dist||1)*dist}px, ${dy/(dist||1)*dist}px)`;
            input.x = dx / 50;
        };
        o.addEventListener('touchstart', move);
        o.addEventListener('touchmove', e => { e.preventDefault(); move(e); }, {passive: false});
        o.addEventListener('touchend', () => { k.style.transform = ''; input.x = 0; });
        document.getElementById('btn-jump').addEventListener('touchstart', (e) => { e.preventDefault(); input.jump = true; });
        document.getElementById('btn-attack').addEventListener('touchstart', (e) => { e.preventDefault(); input.attack = true; });
        document.getElementById('btn-special').addEventListener('touchstart', (e) => { e.preventDefault(); input.special = true; });
    }

    function togglePause() { isPaused = !isPaused; document.getElementById('pause-screen').style.display = isPaused ? 'flex' : 'none'; }
    function resetToMenu() { location.reload(); }
    window.onload = populateUI;
</script>
</body>
</html>

